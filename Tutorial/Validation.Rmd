---
title: "Validation"
author: "Chris Hoover et al"
date: "4/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

devtools::load_all()

library(mapview)

sf_pop <- readRDS(here::here("Tutorial/data/synth_pop.rds"))
load(here::here("Tutorial/data/processed_data.Rdata"))
```

## Validation  
The goal of the synthetic population generation via iterative proportional updating is to match both aggregate totals of the desired characteristics within the target geographic areas--census tracts in this case--and correlations between variables as found in the individual responses that comprise the seed data. 

### Global comparison of SF county to synthetic population  
```{r global_val, echo = FALSE}
# HHincome
SF_hhincome_obs <- colSums(acs_hhincome_tgt[,-1])
SF_hhincome_gen <- sf_pop[!duplicated(sf_pop$house_id),] %>% group_by(hhincome) %>% summarise(n = n())

SF_hhincome_comp <- tibble(vrbl = "hhincome",
                           lvl = as.factor(SF_hhincome_gen$hhincome),
                           obs = SF_hhincome_obs,
                           gen = SF_hhincome_gen$n)

SF_hhincome_comp_plot <- SF_hhincome_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = c(0.2, 0.9)) +
    scale_x_discrete(labels = c("<$50k", "$50k-$100k", ">$100k")) +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Household Type",
         y = "Count",
         fill = "")

# HHtype
SF_hhtype_obs <- colSums(acs_hhtype_tgt[,-1])
SF_hhtype_gen <- sf_pop[!duplicated(sf_pop$house_id),] %>% group_by(hhtype) %>% summarise(n = n())

SF_hhtype_comp <- tibble(vrbl = "hhtype",
                         lvl = as.factor(SF_hhtype_gen$hhtype),
                         obs = SF_hhtype_obs,
                         gen = SF_hhtype_gen$n)

SF_hhtype_comp_plot <- SF_hhtype_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_x_discrete(labels = c("Family", "non-Family")) +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Household Type",
         y = "Count",
         fill = "")


# HHsize
SF_hhsize_obs <- colSums(acs_hhsize_tgt[,-1])
SF_hhsize_gen <- sf_pop[!duplicated(sf_pop$house_id),] %>% group_by(hhsize) %>% summarise(n = n())

SF_hhsize_comp <- tibble(vrbl = "hhsize",
                         lvl = as.factor(SF_hhsize_gen$hhsize),
                         obs = SF_hhsize_obs,
                         gen = SF_hhsize_gen$n)

SF_hhsize_comp_plot <- SF_hhsize_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_x_discrete(labels = c(as.character(c(1:6)), "7+")) +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Household Size",
         y = "Count",
         fill = "")


# Grade
SF_grade_obs <- colSums(acs_grade_tgt[,-1])
SF_grade_gen <- sf_pop %>% group_by(grade) %>% summarise(n = n())

SF_grade_comp <- tibble(vrbl = "grade",
                         lvl = as.factor(SF_grade_gen$grade),
                         obs = SF_grade_obs,
                         gen = SF_grade_gen$n)


SF_grade_comp_plot <- SF_grade_comp %>% 
  filter(lvl != "bb") %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Grade",
         y = "Count",
         fill = "")


# Sex
SF_sex_obs <- colSums(acs_sex_tgt[,-1])
SF_sex_gen <- sf_pop %>% group_by(sex) %>% summarise(n = n())

SF_sex_comp <- tibble(vrbl = "sex",
                      lvl = as.factor(SF_sex_gen$sex),
                      obs = SF_sex_obs,
                      gen = SF_sex_gen$n)

SF_sex_comp_plot <- SF_sex_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_x_discrete(labels = c("Male", "Female")) +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Sex",
         y = "Count",
         fill = "")


# Occupational group
SF_occ_obs <- colSums(acs_occup_tgt[,-1])
SF_occ_gen <- sf_pop %>% group_by(occ_group) %>% summarise(n = n())

SF_occ_comp <- tibble(vrbl = "occ",
                      lvl = as.factor(SF_occ_gen$occ_group),
                      obs = SF_occ_obs,
                      gen = SF_occ_gen$n)

SF_occ_comp_plot <- SF_occ_comp %>% 
  filter(lvl != "99") %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    annotate(geom = "text", 15,70000, label = "* Unemployed not shown") +
    labs(x = "Occupation Category",
         y = "Count",
         fill = "")


# Age Category
SF_age_obs <- colSums(acs_age_tgt[,-1])
SF_age_gen <- sf_pop %>% group_by(age_cat) %>% summarise(n = n())

SF_age_comp <- tibble(vrbl = "age",
                      lvl = as.factor(SF_age_gen$age_cat),
                      obs = SF_age_obs,
                      gen = SF_age_gen$n)

SF_age_comp_plot <- SF_age_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    scale_x_discrete(labels = c("0-9", "10-19", "20-29",
                                "30-39", "40-49", "50-59", 
                                "60-69", "70-79", "80+")) +
    labs(x = "Age Category",
         y = "Count",
         fill = "")


# Race
SF_race_obs <- colSums(acs_race_tgt[,-1])
SF_race_gen <- sf_pop %>% group_by(race) %>% summarise(n = n())

SF_race_comp <- tibble(vrbl = "race",
                       lvl = as.factor(SF_race_gen$race),
                       obs = SF_race_obs,
                       gen = SF_race_gen$n)

SF_race_comp_plot <- SF_race_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    scale_x_discrete(labels = c("White", "Black", "Am. Ind\nAK nat.",
                                "Asian", "HI/PI", "Other", "2+")) +
    labs(x = "Race",
         y = "Count",
         fill = "")


# Hispanic ethnicity
SF_eth_obs <- colSums(acs_eth_tgt[,-1])
SF_eth_gen <- sf_pop %>% group_by(hispanic) %>% summarise(n = n())

SF_eth_comp <- tibble(vrbl = "eth",
                      lvl = as.factor(SF_eth_gen$hispanic),
                      obs = SF_eth_obs,
                      gen = SF_eth_gen$n)

SF_eth_comp_plot <- SF_eth_comp %>% 
  pivot_longer(cols = c("gen", "obs"),
               names_to = "Obs_Gen",
               values_to = "Total") %>% 
  ggplot(aes(x = lvl, y = Total, fill = Obs_Gen)) +
    geom_col(position = "dodge") +
    theme_classic() +
    theme(legend.position = "none") +
    scale_fill_manual(values = c("#6768b2", "#64a3cd")) +
    labs(x = "Hispanic Ethnicity",
         y = "Count",
         fill = "")

# All together
SF_gen_obs_comp <- bind_rows(
  SF_hhincome_comp,
  SF_hhtype_comp,
  SF_hhsize_comp,
  SF_grade_comp,
  SF_sex_comp,
  SF_occ_comp,
  SF_age_comp,
  SF_race_comp,
  SF_eth_comp
) %>% 
  mutate(prop_diff = abs(obs - gen)/obs)


(SF_hhincome_comp_plot | SF_hhtype_comp_plot | SF_hhsize_comp_plot) / (SF_age_comp_plot | SF_sex_comp_plot | SF_grade_comp_plot) / (SF_occ_comp_plot | SF_race_comp_plot | SF_eth_comp_plot)

ggsave(here::here("Plots/SF_Overall_Validation.png"),
       height = 8, width = 12, units = "in")
```

The synthetic population appears to be systematically under-populated in relation to true SF county totals, which makes sense since we've chosen to exclude group quarters and military occupations for now. next we'll look at the percent error in each category across all census tracts.

### Deviation from attribute targets by census tract   

```{r aggregate_validation, eval=FALSE}
n_vars <- length(SF_hh_tgt) + length(SF_p_tgt)
n_cts  <- length(synth_cts)

val_df_tgt <- data.frame("ct"    = rep(synth_cts, times = n_vars),
                         "vrbl"  = rep(c(names(h_tgt), names(p_tgt)), each = n_cts),
                         "pmiss" = NA)

val_df_tgt$pmiss <- apply(val_df_tgt, 1, FUN = function(i){
  ct   = as.character(i[1])
  vrbl = as.character(i[2])
  
  #cat(vrbl, "\n")
  
  if(vrbl %in% names(h_tgt)){
    
    obs <- lapply(SF_hh_tgt, function(i){
      i %>% filter(geo_tract == ct) %>% dplyr::select(-geo_tract)
    })[[vrbl]] %>% 
      pivot_longer(cols = everything(), names_to = vrbl, values_to = "n") %>% 
      group_by(!!as.name(vrbl)) %>% 
      summarise(n = sum(n))
    
    # One obs per household
    sf_ct <- sf_pop %>% filter(GEOID == ct)
    sf_ct_hhs <- sf_ct[!duplicated(sf_ct$house_id),]

    gen <- sf_ct_hhs %>% 
      group_by(!!as.name(vrbl)) %>% 
      dplyr::count()
    
    class(gen[[vrbl]]) <- class(obs[[vrbl]])
    
    jnd <- obs %>% 
      left_join(gen, by = vrbl, suffix = c("_obs", "_gen")) %>% 
      mutate(diff = abs(n_obs - n_gen))
    
    out <- sum(jnd$diff, na.rm = T)/sum(jnd$n_obs)
    
  } else if(vrbl %in% names(p_tgt)){
    
    obs <- lapply(SF_p_tgt, function(j){
      j %>% filter(geo_tract == ct) %>% dplyr::select(-geo_tract)
    })[[vrbl]] %>% 
       pivot_longer(cols = everything(), names_to = vrbl, values_to = "n")
    
    gen <- sf_pop %>% 
      filter(GEOID == ct) %>% 
      group_by(!!as.name(vrbl)) %>% 
      dplyr::count()
    
    class(gen[[vrbl]]) <- class(obs[[vrbl]])

    jnd <- obs %>% 
      left_join(gen, by = vrbl, suffix = c("_obs", "_gen")) %>% 
      mutate(diff = abs(n_obs - n_gen))

    out <- sum(jnd$diff, na.rm = T)/sum(jnd$n_obs)

  } else {
    
    stop("Variable has no match in target data")
    
  }
  
  return(out)
  
})

val_df_tgt %>% 
  ggplot(aes(x = vrbl, y = pmiss, fill = vrbl)) +
    geom_violin() +
    scale_y_continuous(breaks = seq(0,2, by = 0.1)) +
    theme_classic()

ggsave(here::here("Plots/SF_PctError_Distn_Validation.png"),
       height = 4, width = 5, units = "in")

```

Large error rates among household level variables are driven by census tracts that contain universities (SF State, USF) or large military populations (The Presidio and Treasure Islane). These discrepancies will be resolved when incorporating group quarters. Otherwise, error rates are generally below 10%

```{r high_error_rates}
high_err_cts <- val_df_tgt %>% 
  filter(pmiss > 0.5) %>% 
  pull(ct) %>% 
  unique()

sf_ct_geo <- tidycensus::get_acs(state = "CA", county = "San Francisco", geography = "tract", 
                                 table = "B01001", geometry = TRUE)

sf_ct_geo2 <- sf_ct_geo[!duplicated(sf_ct_geo$GEOID),] %>% 
  mutate(`High Error` = if_else(GEOID %in% high_err_cts, 1, 0))

mapview::mapview(sf_ct_geo2, zcol = "High Error", alpha = 0.2)
```

